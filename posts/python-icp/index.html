<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Python 进程间通信 | Rrcgat</title><meta name=keywords content="Python"><meta name=description content="进程间通信的几种方式 参考维基百科的分类，进程间通信主要有以下几种：
文件（File） 信号（Signal） 套接字（Socket） Unix 域套接字（Unix domain socket） 消息队列（Message queue） 匿名管道（Anonymous pipe） 命名管道（Named pipe） 共享内存（Shared memory） 消息传递（Message passing） 内存映射文件（Memory-mapped file） 看下使用 Python 怎么实现。
环境：Arch Linux + Python3.8
文件 符合直觉，数据存在硬盘上，可基于文本或二进制。
对于 pa.py
SHARED_FILE = '/tmp/shared_file' def send(): with open(SHARED_FILE, 'w', encoding='utf-8') as f: f.write('some data...') 对于 pb.py
def receive(): with open(SHARED_FILE, encoding='utf-8') as f: print(f.read()) 为了避免竞争，数据流向是单向的，可使用两个或以上的文件进行双向通信。
信号 通信偏向底层，且一般不用于传输数据。
Python 中有 os.kill(pid, sig) 以及 signal 模块。 os.kill 发送 sig 给进程 pid，一般会意外终止进程 pid。"><meta name=author content><link rel=canonical href=https://rrcgat.github.io/posts/python-icp/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://rrcgat.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rrcgat.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rrcgat.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://rrcgat.github.io/apple-touch-icon.png><link rel=mask-icon href=https://rrcgat.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Python 进程间通信"><meta property="og:description" content="进程间通信的几种方式 参考维基百科的分类，进程间通信主要有以下几种：
文件（File） 信号（Signal） 套接字（Socket） Unix 域套接字（Unix domain socket） 消息队列（Message queue） 匿名管道（Anonymous pipe） 命名管道（Named pipe） 共享内存（Shared memory） 消息传递（Message passing） 内存映射文件（Memory-mapped file） 看下使用 Python 怎么实现。
环境：Arch Linux + Python3.8
文件 符合直觉，数据存在硬盘上，可基于文本或二进制。
对于 pa.py
SHARED_FILE = '/tmp/shared_file' def send(): with open(SHARED_FILE, 'w', encoding='utf-8') as f: f.write('some data...') 对于 pb.py
def receive(): with open(SHARED_FILE, encoding='utf-8') as f: print(f.read()) 为了避免竞争，数据流向是单向的，可使用两个或以上的文件进行双向通信。
信号 通信偏向底层，且一般不用于传输数据。
Python 中有 os.kill(pid, sig) 以及 signal 模块。 os.kill 发送 sig 给进程 pid，一般会意外终止进程 pid。"><meta property="og:type" content="article"><meta property="og:url" content="https://rrcgat.github.io/posts/python-icp/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-25T00:14:58+08:00"><meta property="article:modified_time" content="2020-05-25T00:14:58+08:00"><meta property="og:site_name" content="rrcgat"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python 进程间通信"><meta name=twitter:description content="进程间通信的几种方式 参考维基百科的分类，进程间通信主要有以下几种：
文件（File） 信号（Signal） 套接字（Socket） Unix 域套接字（Unix domain socket） 消息队列（Message queue） 匿名管道（Anonymous pipe） 命名管道（Named pipe） 共享内存（Shared memory） 消息传递（Message passing） 内存映射文件（Memory-mapped file） 看下使用 Python 怎么实现。
环境：Arch Linux + Python3.8
文件 符合直觉，数据存在硬盘上，可基于文本或二进制。
对于 pa.py
SHARED_FILE = '/tmp/shared_file' def send(): with open(SHARED_FILE, 'w', encoding='utf-8') as f: f.write('some data...') 对于 pb.py
def receive(): with open(SHARED_FILE, encoding='utf-8') as f: print(f.read()) 为了避免竞争，数据流向是单向的，可使用两个或以上的文件进行双向通信。
信号 通信偏向底层，且一般不用于传输数据。
Python 中有 os.kill(pid, sig) 以及 signal 模块。 os.kill 发送 sig 给进程 pid，一般会意外终止进程 pid。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rrcgat.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Python 进程间通信","item":"https://rrcgat.github.io/posts/python-icp/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Python 进程间通信","name":"Python 进程间通信","description":"进程间通信的几种方式 参考维基百科的分类，进程间通信主要有以下几种：\n文件（File） 信号（Signal） 套接字（Socket） Unix 域套接字（Unix domain socket） 消息队列（Message queue） 匿名管道（Anonymous pipe） 命名管道（Named pipe） 共享内存（Shared memory） 消息传递（Message passing） 内存映射文件（Memory-mapped file） 看下使用 Python 怎么实现。\n环境：Arch Linux + Python3.8\n文件 符合直觉，数据存在硬盘上，可基于文本或二进制。\n对于 pa.py\nSHARED_FILE = \u0026#39;/tmp/shared_file\u0026#39; def send(): with open(SHARED_FILE, \u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: f.write(\u0026#39;some data...\u0026#39;) 对于 pb.py\ndef receive(): with open(SHARED_FILE, encoding=\u0026#39;utf-8\u0026#39;) as f: print(f.read()) 为了避免竞争，数据流向是单向的，可使用两个或以上的文件进行双向通信。\n信号 通信偏向底层，且一般不用于传输数据。\nPython 中有 os.kill(pid, sig) 以及 signal 模块。 os.kill 发送 sig 给进程 pid，一般会意外终止进程 pid。","keywords":["Python"],"articleBody":"进程间通信的几种方式 参考维基百科的分类，进程间通信主要有以下几种：\n文件（File） 信号（Signal） 套接字（Socket） Unix 域套接字（Unix domain socket） 消息队列（Message queue） 匿名管道（Anonymous pipe） 命名管道（Named pipe） 共享内存（Shared memory） 消息传递（Message passing） 内存映射文件（Memory-mapped file） 看下使用 Python 怎么实现。\n环境：Arch Linux + Python3.8\n文件 符合直觉，数据存在硬盘上，可基于文本或二进制。\n对于 pa.py\nSHARED_FILE = '/tmp/shared_file' def send(): with open(SHARED_FILE, 'w', encoding='utf-8') as f: f.write('some data...') 对于 pb.py\ndef receive(): with open(SHARED_FILE, encoding='utf-8') as f: print(f.read()) 为了避免竞争，数据流向是单向的，可使用两个或以上的文件进行双向通信。\n信号 通信偏向底层，且一般不用于传输数据。\nPython 中有 os.kill(pid, sig) 以及 signal 模块。 os.kill 发送 sig 给进程 pid，一般会意外终止进程 pid。\nimport os import signal os.kill(48523, signal.SIGKILL) signal 模块的例子可以看 signal — Set handlers for asynchronous events 中给出的，简洁明了。\n套接字 使用 socket 模块，C/S 形式的通信。\n对于 pa.py\n# Echo server program import socket HOST = '127.0.0.1' PORT = 50007 def send(): with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s: s.bind((HOST, PORT)) # 绑定地址与端口 s.listen(1) # 监听的连接数 conn, addr = s.accept() with conn: print('Connected by', addr) while True: data = conn.recv(1024) if not data: break conn.sendall(data) 对于 pb.py\n# Echo client program import socket HOST = '127.0.0.1' PORT = 50007 def receive(): with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s: s.connect((HOST, PORT)) s.sendall(b'Hello, world') data = s.recv(1024) print('Received', repr(data)) 例子来自于官方文档中的 socket — Low-level networking interface，稍作修改。\n在 Python3.8 中，新增了 socket.create_server 函数，合并了 bind 这一步。 对应的 socket.create_connection 函数用于创建连接。\nUnix 域套接字 Unix 域套接字不经过网络，直接在内核中通信。\n使用方法与 socket.AF_INET 或 socket.AF_INET6 相似， 只需把对应的 socket.AF_INET 或 socket.AF_INET6 改为 socket.AF_UNIX， 绑定或连接的地址由 (HOST, PORT) 变为本地文件，如 '/tmp/unix_socket'。\n消息队列 Python 标准库中，multiprocessing.Queue 只能用于有关系的进程中， 而借助第三方库的 ipcqueue 或 sysv_ipc，可在独立的进程中通信。\nipcqueue 支持 POSIX 和 System V 形式的消息队列。\n看下 POSIX 标准的消息队列。\npa.py\nfrom ipcqueue import posixmq def send(): q = posixmq.Queue('/foo') q.put([1, 'A']) q.put([2, 'B'], priority=2) # priority 参数设置优先级 q.put([3, 'C'], priority=0) pb.py\nfrom ipcqueue import posixmq def receive(): q = posixmq.Queue('/foo') print(q.get()) print(q.get()) print(q.get()) q.close() q.unlink() 而 System V 消息队列稍有不同。\npa.py\nfrom ipcqueue import sysvmq def send(): q = sysvmq.Queue(1) q.put([1, 'A']) q.put([2, 'B'], msg_type=2) q.put([3, 'C'], msg_type=2) q.put([4, 'D'], msg_type=1) pb.py\nfrom ipcqueue import sysvmq def receive(): q = sysvmq.Queue(1) print(q.get(msg_type=2)) # msg_type 参数设置消息类型 print(q.get()) print(q.get()) print(q.get()) q.close() 以上代码修改自 ipcqueue documentation。\n两者用法类似，但有一些不同，主要有：\nPOSIX message queue 的标识符为字符，且必须以 / 开头； 而 System V message queue 标识符为整数，且不能为负数。 为 0 时，表示私有队列。 POSIX message queue 可以设置优先线，读取消息按 FIFO 方式来读； System V message queue 无优先级概念，但可以设置消息类型， 并按消息类型以 FIFO 方式读取，而 POSIX message queue 不区分消息类型。 匿名管道 匿名管道用于父子进程间打开读写通道进行通信， 在大多数 Shell 中可以使用 | 来创建。\nimport os import sys def main(): r, w = os.pipe() if os.fork(): # Parent process receive data os.close(w) r = os.fdopen(r) print('Parent reading', r.read()) r.close() sys.exit(0) else: # Child process write data os.close(r) w = os.fdopen(w, 'w') w.write('Hello, world') w.close() sys.exit(0) 要双向通信，可打开两条管道。multiprocessing.Pipe 可直接支持双工管道。\n命名管道 不同于匿名管道，命名管道利用了文件系统，可用于两个无关的进程中进行通信。\npa.py\nimport os import errno FIFO = '/tmp/named_pipe' def send(): try: os.mkfifo(FIFO) except OSError as oe: if oe.errno != errno.EEXIST: raise oe with open(FIFO, 'w') as f: f.write('Hello, world') pb.py\nimport os FIFO = '/tmp/named_pipe' def receive(): try: os.mkfifo(FIFO) except OSError: pass with open(FIFO) as f: while True: data = f.read() if len(data): print(data) else: break 两者均是阻塞直到另一方打开，但可以使用 os.open 进行非阻塞通信。\n代码修改自 Python read named PIPE，且仅适用于 Unix 平台。 Windows 系统需要借助 win32pipe 和 win32file， 具体可以看 Named Pipes Communication between Python Server and Python Client on Window。\n共享内存 共享内存是可以被不同进程同时访问的内存空间，可跨不同进程通信。\nPython3.8 中新增了 multiprocessing.shared_memory 模块以支持共享内存通信， 使用的是 System V 风格。之前提到的 sysv_ipc 也可以用于共享内存通信，同样是 System V 风格。\n官方文档中使用 Numpy 演示 multiprocessing.shared_memory。 查看源代码，发现对象销毁会调用 self.close 关闭共享内存的访问， 所以必须保证两个进程活着才行。\nsysv_ipc 除了消息队列和共享内存，还可使用信号量进行通信。\n消息传递 消息传递是一项在计算机上激活动作（即运行程序）的技术。 与传统按名字调用程序的方式不同， 消息传递使用对象模型（object model）区别常规功能与特定实现。 被激活的程序发送一条消息，并依靠对象选择并执行对应的代码。 使用中间层的理由基本分为两类：封装和分发。\n以上文字翻译自 Message passing，可能不太准确。\n常见的消息传递系统有 RPC、RMI、MPI。\n以 MPI 为例子。Python 中实现包括 pyMPI、mpi4py、pypar、MYMPI 和 ScientificPython 的子模块 MPI。这里使用 mpi4py 模块。\nimport numpy from mpi4py import MPI comm = MPI.COMM_WORLD rank = comm.Get_rank() rand_num = numpy.zeros(1) if rank == 1: rand_num = numpy.random.random_sample(1) print(\"Process\", rank, \"drew the number\", rand_num[0]) comm.Send(rand_num, dest=0) if rank == 0: print(\"Process\", rank, \"before receiving has the number\", rand_num[0]) comm.Recv(rand_num, source=1) print(\"Process\", rank, \"received the number\", rand_num[0]) 将代码保存为 mpi.py，执行命令 mpiexec -n 2 python mpi.py。 -n 选项指定进程数。同时启动一组进程， 每个进程都有一个唯一的编号（在这是 rank）， 根据不同的编号，程序执行不同的代码。 不同进程可以通过 Send 和 Recv 进行通信。\n代码参考自 Python MPI: Message Passing。\n内存映射文件 与共享内存类似，但将内存映射为文件。直接看看怎么用。\n这里直接使用标准库中的 mmap 模块。\npa.py\nimport mmap import os path = '/tmp/mmapfile' def send(): fd = os.open(path, os.O_CREAT | os.O_TRUNC | os.O_RDWR) data = b'Hello, world' os.write(fd, b'\\x00' * len(data)) mm = mmap.mmap(fd, 0) mm[:] = data pb.py\nimport mmap import os path = '/tmp/mmapfile' def receive(): fd = os.open(path, os.O_RDONLY) mm = mmap.mmap(fd, 0, prot=mmap.PROT_READ) print(mm[:]) 文件描述符为 -1 时，表示映射匿名内存。\nWindows 有一点不同，还可直接使用 mmap.mmap(0, length, tagname)进行通信。\n更多参考 Welcome to ipcqueue’s documentation! System V IPC for Python 细说linux IPC（十）：system V 消息队列 mq_overview(7) - Linux man page ","wordCount":"679","inLanguage":"zh","datePublished":"2020-05-25T00:14:58+08:00","dateModified":"2020-05-25T00:14:58+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://rrcgat.github.io/posts/python-icp/"},"publisher":{"@type":"Organization","name":"Rrcgat","logo":{"@type":"ImageObject","url":"https://rrcgat.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rrcgat.github.io/ accesskey=h title="Rrcgat (Alt + H)"><img src=https://rrcgat.github.io/apple-touch-icon.png alt aria-label=logo height=35>Rrcgat</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rrcgat.github.io/about/ title=关于我><span>关于我</span></a></li><li><a href=https://rrcgat.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://rrcgat.github.io/posts/ title=文章><span>文章</span></a></li><li><a href=https://rrcgat.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://rrcgat.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rrcgat.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://rrcgat.github.io/posts/>Posts</a></div><h1 class=post-title>Python 进程间通信</h1><div class=post-meta><span title='2020-05-25 00:14:58 +0800 CST'>2020-05-25</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;679 字</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#进程间通信的几种方式>进程间通信的几种方式</a><ul><li><a href=#文件>文件</a></li><li><a href=#信号>信号</a></li><li><a href=#套接字>套接字</a></li><li><a href=#unix-域套接字>Unix 域套接字</a></li><li><a href=#消息队列>消息队列</a></li><li><a href=#匿名管道>匿名管道</a></li><li><a href=#命名管道>命名管道</a></li><li><a href=#共享内存>共享内存</a></li><li><a href=#消息传递>消息传递</a></li><li><a href=#内存映射文件>内存映射文件</a></li></ul></li><li><a href=#更多参考>更多参考</a></li></ul></nav></div></details></div><div class=post-content><h2 id=进程间通信的几种方式>进程间通信的几种方式<a hidden class=anchor aria-hidden=true href=#进程间通信的几种方式>#</a></h2><p>参考维基百科的分类，进程间通信主要有以下几种：</p><ul><li>文件（File）</li><li>信号（Signal）</li><li>套接字（Socket）</li><li>Unix 域套接字（Unix domain socket）</li><li>消息队列（Message queue）</li><li>匿名管道（Anonymous pipe）</li><li>命名管道（Named pipe）</li><li>共享内存（Shared memory）</li><li>消息传递（Message passing）</li><li>内存映射文件（Memory-mapped file）</li></ul><p>看下使用 Python 怎么实现。</p><p>环境：Arch Linux + Python3.8</p><h3 id=文件>文件<a hidden class=anchor aria-hidden=true href=#文件>#</a></h3><p>符合直觉，数据存在硬盘上，可基于文本或二进制。</p><p>对于 pa.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>SHARED_FILE</span> <span class=o>=</span> <span class=s1>&#39;/tmp/shared_file&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>SHARED_FILE</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;some data...&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>对于 pb.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>receive</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>SHARED_FILE</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span></code></pre></div><p>为了避免竞争，数据流向是单向的，可使用两个或以上的文件进行双向通信。</p><h3 id=信号>信号<a hidden class=anchor aria-hidden=true href=#信号>#</a></h3><p>通信偏向底层，且一般不用于传输数据。</p><p>Python 中有 <code>os.kill(pid, sig)</code> 以及 <code>signal</code> 模块。
<code>os.kill</code> 发送 <code>sig</code> 给进程 <code>pid</code>，一般会意外终止进程 <code>pid</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>signal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>kill</span><span class=p>(</span><span class=mi>48523</span><span class=p>,</span> <span class=n>signal</span><span class=o>.</span><span class=n>SIGKILL</span><span class=p>)</span>
</span></span></code></pre></div><p><code>signal</code> 模块的例子可以看 <a href=https://docs.python.org/3/library/signal.html#example>signal — Set handlers for asynchronous events</a> 中给出的，简洁明了。</p><h3 id=套接字>套接字<a hidden class=anchor aria-hidden=true href=#套接字>#</a></h3><p>使用 <code>socket</code> 模块，C/S 形式的通信。</p><p>对于 pa.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Echo server program</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HOST</span> <span class=o>=</span> <span class=s1>&#39;127.0.0.1&#39;</span>
</span></span><span class=line><span class=cl><span class=n>PORT</span> <span class=o>=</span> <span class=mi>50007</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span> <span class=k>as</span> <span class=n>s</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>HOST</span><span class=p>,</span> <span class=n>PORT</span><span class=p>))</span>  <span class=c1># 绑定地址与端口</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># 监听的连接数</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Connected by&#39;</span><span class=p>,</span> <span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span></code></pre></div><p>对于 pb.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Echo client program</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HOST</span> <span class=o>=</span> <span class=s1>&#39;127.0.0.1&#39;</span>
</span></span><span class=line><span class=cl><span class=n>PORT</span> <span class=o>=</span> <span class=mi>50007</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>receive</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span> <span class=k>as</span> <span class=n>s</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>HOST</span><span class=p>,</span> <span class=n>PORT</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Hello, world&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Received&#39;</span><span class=p>,</span> <span class=nb>repr</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span></code></pre></div><p>例子来自于官方文档中的 <a href=https://docs.python.org/3/library/socket.html#example>socket — Low-level networking interface</a>，稍作修改。</p><p>在 Python3.8 中，新增了 <code>socket.create_server</code> 函数，合并了 <code>bind</code> 这一步。
对应的 <code>socket.create_connection</code> 函数用于创建连接。</p><h3 id=unix-域套接字>Unix 域套接字<a hidden class=anchor aria-hidden=true href=#unix-域套接字>#</a></h3><p>Unix 域套接字不经过网络，直接在内核中通信。</p><p>使用方法与 <code>socket.AF_INET</code> 或 <code>socket.AF_INET6</code> 相似，
只需把对应的 <code>socket.AF_INET</code> 或 <code>socket.AF_INET6</code> 改为 <code>socket.AF_UNIX</code>，
绑定或连接的地址由 <code>(HOST, PORT)</code> 变为本地文件，如 <code>'/tmp/unix_socket'</code>。</p><h3 id=消息队列>消息队列<a hidden class=anchor aria-hidden=true href=#消息队列>#</a></h3><p>Python 标准库中，<a href=https://docs.python.org/3/library/multiprocessing.html#multiprocessing.Queue><code>multiprocessing.Queue</code></a> 只能用于有关系的进程中，
而借助第三方库的 <code>ipcqueue</code> 或 <code>sysv_ipc</code>，可在独立的进程中通信。</p><p><code>ipcqueue</code> 支持 <code>POSIX</code> 和 <code>System V</code> 形式的消息队列。</p><p>看下 <code>POSIX</code> 标准的消息队列。</p><p>pa.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ipcqueue</span> <span class=kn>import</span> <span class=n>posixmq</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>posixmq</span><span class=o>.</span><span class=n>Queue</span><span class=p>(</span><span class=s1>&#39;/foo&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>([</span><span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>],</span> <span class=n>priority</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>  <span class=c1># priority 参数设置优先级</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>([</span><span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>],</span> <span class=n>priority</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><p>pb.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ipcqueue</span> <span class=kn>import</span> <span class=n>posixmq</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>receive</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>posixmq</span><span class=o>.</span><span class=n>Queue</span><span class=p>(</span><span class=s1>&#39;/foo&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>unlink</span><span class=p>()</span>
</span></span></code></pre></div><p>而 <code>System V</code> 消息队列稍有不同。</p><p>pa.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ipcqueue</span> <span class=kn>import</span> <span class=n>sysvmq</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>sysvmq</span><span class=o>.</span><span class=n>Queue</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>([</span><span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>],</span> <span class=n>msg_type</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>([</span><span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>],</span> <span class=n>msg_type</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>([</span><span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;D&#39;</span><span class=p>],</span> <span class=n>msg_type</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><p>pb.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ipcqueue</span> <span class=kn>import</span> <span class=n>sysvmq</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>receive</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>sysvmq</span><span class=o>.</span><span class=n>Queue</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>msg_type</span><span class=o>=</span><span class=mi>2</span><span class=p>))</span>  <span class=c1># msg_type 参数设置消息类型</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><p>以上代码修改自 <a href=https://pythonhosted.org/ipcqueue/#>ipcqueue documentation</a>。</p><p>两者用法类似，但有一些不同，主要有：</p><ol><li>POSIX message queue 的标识符为字符，且必须以 <code>/</code> 开头；
而 System V message queue 标识符为整数，且不能为负数。
为 0 时，表示私有队列。</li><li>POSIX message queue 可以设置优先线，读取消息按 FIFO 方式来读；
System V message queue 无优先级概念，但可以设置消息类型，
并按消息类型以 FIFO 方式读取，而 POSIX message queue 不区分消息类型。</li></ol><h3 id=匿名管道>匿名管道<a hidden class=anchor aria-hidden=true href=#匿名管道>#</a></h3><p>匿名管道用于父子进程间打开读写通道进行通信，
在大多数 Shell 中可以使用 <code>|</code> 来创建。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>pipe</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>fork</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># Parent process receive data</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>fdopen</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Parent reading&#39;</span><span class=p>,</span> <span class=n>r</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Child process write data</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>w</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>fdopen</span><span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>w</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;Hello, world&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>w</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><p>要双向通信，可打开两条管道。<code>multiprocessing.Pipe</code> 可直接支持双工管道。</p><h3 id=命名管道>命名管道<a hidden class=anchor aria-hidden=true href=#命名管道>#</a></h3><p>不同于匿名管道，命名管道利用了文件系统，可用于两个无关的进程中进行通信。</p><p>pa.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>errno</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FIFO</span> <span class=o>=</span> <span class=s1>&#39;/tmp/named_pipe&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>mkfifo</span><span class=p>(</span><span class=n>FIFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>OSError</span> <span class=k>as</span> <span class=n>oe</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>oe</span><span class=o>.</span><span class=n>errno</span> <span class=o>!=</span> <span class=n>errno</span><span class=o>.</span><span class=n>EEXIST</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>oe</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>FIFO</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;Hello, world&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>pb.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FIFO</span> <span class=o>=</span> <span class=s1>&#39;/tmp/named_pipe&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>receive</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>mkfifo</span><span class=p>(</span><span class=n>FIFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>OSError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>FIFO</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span></code></pre></div><p>两者均是阻塞直到另一方打开，但可以使用 <code>os.open</code> 进行非阻塞通信。</p><p>代码修改自 <a href=https://stackoverflow.com/questions/39089776/python-read-named-pipe>Python read named PIPE</a>，且仅适用于 Unix 平台。
Windows 系统需要借助 <code>win32pipe</code> 和 <code>win32file</code>，
具体可以看 <a href=https://medium.com/datadriveninvestor/named-pipes-communication-between-python-server-and-python-client-on-window-8cdf64504801>Named Pipes Communication between Python Server and Python Client on Window</a>。</p><h3 id=共享内存>共享内存<a hidden class=anchor aria-hidden=true href=#共享内存>#</a></h3><p>共享内存是可以被不同进程同时访问的内存空间，可跨不同进程通信。</p><p>Python3.8 中新增了 <a href=https://docs.python.org/3/library/multiprocessing.shared_memory.html><code>multiprocessing.shared_memory</code></a> 模块以支持共享内存通信，
使用的是 System V 风格。之前提到的 <a href=http://semanchuk.com/philip/sysv_ipc/><code>sysv_ipc</code></a> 也可以用于共享内存通信，同样是 System V 风格。</p><p>官方文档中使用 Numpy 演示 <code>multiprocessing.shared_memory</code>。
查看<a href=https://github.com/python/cpython/blob/3.8/Lib/multiprocessing/shared_memory.py>源代码</a>，发现对象销毁会调用 <code>self.close</code> 关闭共享内存的访问，
所以必须保证两个进程活着才行。</p><p><code>sysv_ipc</code> 除了消息队列和共享内存，还可使用信号量进行通信。</p><h3 id=消息传递>消息传递<a hidden class=anchor aria-hidden=true href=#消息传递>#</a></h3><blockquote><p>消息传递是一项在计算机上激活动作（即运行程序）的技术。
与传统按名字调用程序的方式不同，
消息传递使用对象模型（object model）区别常规功能与特定实现。
被激活的程序发送一条消息，并依靠对象选择并执行对应的代码。
使用中间层的理由基本分为两类：封装和分发。</p></blockquote><p>以上文字翻译自 <a href=https://en.wikipedia.org/wiki/Message_passing#Overview>Message passing</a>，可能不太准确。</p><p>常见的消息传递系统有 RPC、RMI、MPI。</p><p>以 MPI 为例子。Python 中实现包括 pyMPI、mpi4py、pypar、MYMPI 和 ScientificPython 的子模块 MPI。这里使用 <a href=https://mpi4py.readthedocs.io/en/stable/>mpi4py</a> 模块。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpi4py</span> <span class=kn>import</span> <span class=n>MPI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>comm</span> <span class=o>=</span> <span class=n>MPI</span><span class=o>.</span><span class=n>COMM_WORLD</span>
</span></span><span class=line><span class=cl><span class=n>rank</span> <span class=o>=</span> <span class=n>comm</span><span class=o>.</span><span class=n>Get_rank</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rand_num</span> <span class=o>=</span> <span class=n>numpy</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>rank</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>rand_num</span> <span class=o>=</span> <span class=n>numpy</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>random_sample</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Process&#34;</span><span class=p>,</span> <span class=n>rank</span><span class=p>,</span> <span class=s2>&#34;drew the number&#34;</span><span class=p>,</span> <span class=n>rand_num</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>comm</span><span class=o>.</span><span class=n>Send</span><span class=p>(</span><span class=n>rand_num</span><span class=p>,</span> <span class=n>dest</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>rank</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Process&#34;</span><span class=p>,</span> <span class=n>rank</span><span class=p>,</span> <span class=s2>&#34;before receiving has the number&#34;</span><span class=p>,</span> <span class=n>rand_num</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>comm</span><span class=o>.</span><span class=n>Recv</span><span class=p>(</span><span class=n>rand_num</span><span class=p>,</span> <span class=n>source</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Process&#34;</span><span class=p>,</span> <span class=n>rank</span><span class=p>,</span> <span class=s2>&#34;received the number&#34;</span><span class=p>,</span> <span class=n>rand_num</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span></code></pre></div><p>将代码保存为 mpi.py，执行命令 <code>mpiexec -n 2 python mpi.py</code>。
<code>-n</code> 选项指定进程数。同时启动一组进程，
每个进程都有一个唯一的编号（在这是 <code>rank</code>），
根据不同的编号，程序执行不同的代码。
不同进程可以通过 <code>Send</code> 和 <code>Recv</code> 进行通信。</p><p>代码参考自 <a href=https://nyu-cds.github.io/python-mpi/02-messagepassing/>Python MPI: Message Passing</a>。</p><h3 id=内存映射文件>内存映射文件<a hidden class=anchor aria-hidden=true href=#内存映射文件>#</a></h3><p>与共享内存类似，但将内存映射为文件。直接看看怎么用。</p><p>这里直接使用标准库中的 <a href=https://docs.python.org/3/library/mmap.html><code>mmap</code></a> 模块。</p><p>pa.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>mmap</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>path</span> <span class=o>=</span> <span class=s1>&#39;/tmp/mmapfile&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>fd</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>os</span><span class=o>.</span><span class=n>O_CREAT</span> <span class=o>|</span> <span class=n>os</span><span class=o>.</span><span class=n>O_TRUNC</span> <span class=o>|</span> <span class=n>os</span><span class=o>.</span><span class=n>O_RDWR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;Hello, world&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mm</span> <span class=o>=</span> <span class=n>mmap</span><span class=o>.</span><span class=n>mmap</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mm</span><span class=p>[:]</span> <span class=o>=</span> <span class=n>data</span>
</span></span></code></pre></div><p>pb.py</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>mmap</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>path</span> <span class=o>=</span> <span class=s1>&#39;/tmp/mmapfile&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>receive</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>fd</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>os</span><span class=o>.</span><span class=n>O_RDONLY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mm</span> <span class=o>=</span> <span class=n>mmap</span><span class=o>.</span><span class=n>mmap</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>prot</span><span class=o>=</span><span class=n>mmap</span><span class=o>.</span><span class=n>PROT_READ</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>mm</span><span class=p>[:])</span>
</span></span></code></pre></div><p>文件描述符为 <code>-1</code> 时，表示映射匿名内存。</p><p>Windows 有一点不同，还可直接使用 <code>mmap.mmap(0, length, tagname)</code>进行通信。</p><h2 id=更多参考>更多参考<a hidden class=anchor aria-hidden=true href=#更多参考>#</a></h2><ul><li><a href=https://pythonhosted.org/ipcqueue/#>Welcome to ipcqueue’s documentation!</a></li><li><a href=http://semanchuk.com/philip/sysv_ipc/>System V IPC for Python</a></li><li><a href=https://blog.csdn.net/gentleliu/article/details/41806415>细说linux IPC（十）：system V 消息队列</a></li><li><a href=https://linux.die.net/man/7/mq_overview>mq_overview(7) - Linux man page</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://rrcgat.github.io/tags/python/>Python</a></li></ul><nav class=paginav><a class=prev href=https://rrcgat.github.io/posts/common-lisp-equality/><span class=title>« 上一页</span><br><span>Common Lisp 中的相等性判断</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=rrcgat/rrcgat.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyMjA3NjA4MTM=" data-category=Announcements data-category-id=DIC_kwDODSiK7c4CUeUP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2023 <a href=https://rrcgat.github.io/>Rrcgat</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>